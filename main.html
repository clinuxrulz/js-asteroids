<html>
	<head>
		<script src='wire.js'></script>
		<script src='sound.js'></script>
		<script>

var constants = {
	turnLeft: 37,   // left arrow
	turnRight: 39,  // right arrow
	accelerate: 38, // up arrow
	fire: 32,       // space key
	turnSpeed: 270.0,
	acceleration: 30.0,
	fireRate: 5,       // bullets per second
	bulletSize: 5,
	bulletSpeed: 500.0,
	bulletLifespan: 5   // seconds
};

var commandWires;

// keyDownWire :: Applicative m => KeyCode -> Wire m Input Bool
var keyDownWire = function(m, keyCode) {
	var keyDownWire2 = function(wasDown) {
		return function(dt, x) {
			return m.pure(x({
				wvInhibited: function() {
					return [wvInhibited,keyDownWire2(wasDown)];
				},
				wvUnchanged: function(a) {
					return [wvUnchanged(wasDown),keyDownWire2(wasDown)];
				},
				wvChanged: function(a) {
					if (wasDown && a.type == "keyUp" && a.keyCode == keyCode) {
						return [wvChanged(false), keyDownWire2(false)];
					} else if (!wasDown && a.type == "keyDown" && a.keyCode == keyCode) {
						return [wvChanged(true), keyDownWire2(true)];
					} else {
						return [wvUnchanged(wasDown),keyDownWire2(wasDown)];
					}
				}
			}));
		};
	};
	return function(dt, x) {
		return m.pure(x({
			wvInhibited: function() {
				return [wvInhibited,keyDownWire(m,keyCode)];
			},
			wvUnchanged: function(a) {
				if (a.type == "keyDown" && a.keyCode == keyCode) {
					return [wvChanged(true), keyDownWire2(true)];
				} else {
					return [wvChanged(false), keyDownWire2(false)];
				}
			},
			wvChanged: function(a) {
				if (a.type == "keyDown" && a.keyCode == keyCode) {
					return [wvChanged(true), keyDownWire2(true)];
				} else {
					return [wvChanged(false), keyDownWire2(false)];
				}
			}
		}));
	};
};

var shipTurnSpeedWire = wire(io).apply2(
	curry(function(turnLeft,turnRight) {
		if (turnLeft && turnRight) {
			return 0.0;
		} else if (turnLeft) {
			return -constants.turnSpeed;
		} else if (turnRight) {
			return constants.turnSpeed;
		} else {
			return 0.0;
		}
	}),
	keyDownWire(io, constants.turnLeft),
	keyDownWire(io, constants.turnRight)
);

var shipAngleWire = wire(io).o(
	wire(io).integral(0),
	shipTurnSpeedWire
);

var shipAccelerationWire = wire(io).apply2(
	curry(function(angle, accelerate) {
		if (accelerate) {
			return [
				-Math.sin(angle * Math.PI / 180.0) * constants.acceleration,
				Math.cos(angle * Math.PI / 180.0) * constants.acceleration
			];
		} else {
			return [0,0];
		}
	}),
	shipAngleWire,
	keyDownWire(io, constants.accelerate)
);

var shipVelocityWire = wire(io).o(
	wire(io).split(
		wire(io).integral(0),
		wire(io).integral(0)
	),
	shipAccelerationWire
);

var shipPositionWire = wire(io).o(
	wire(io).split(
		wire(io).integral(100),
		wire(io).integral(100)
	),
	shipVelocityWire
);

var shipHasFiredWire = wire(io).arr(function(input) {
	return input.type == "fire";
});

var shipFireWire = wire(io).apply2(
	curry(function(fire, timeSinceFired) {
		return fire && (timeSinceFired >= 1.0 / constants.fireRate);
	}),
	keyDownWire(io, constants.fire),
	wire(io).o(
		wire(io).integralWith(
			curry(function(shipHasFired, timeSinceFired) {
				if (shipHasFired) {
					return 0.0;
				} else {
					return timeSinceFired;
				}
			}),
			0
		),
		wire(io).fanout(
			wire(io).pure(1),
			shipHasFiredWire
		)
	)
);

var spawnBulletIO = function(pos, dir) {
	return function() {
		var bullet = document.createElementNS("http://www.w3.org/2000/svg", "circle");
		bullet.setAttribute("cx", pos[0]);
		bullet.setAttribute("cy", pos[1]);
		bullet.setAttribute("r", 0.5 * constants.bulletSize);
		svg.appendChild(bullet);
		commandWires.push(bulletCommandWire(bullet, pos, dir));
		return bullet;
	};
};

var bulletPositionWire = function(initPos, dir) {
	return wire(io).o(
		wire(io).split(
			wire(io).integral(initPos[0]),
			wire(io).integral(initPos[1])
		),
		wire(io).apply2(
			curry(function(a, b) {
				return [a[0]+b[0],a[1]+b[1]];
			}),
			wire(io).pure([
				dir[0] * constants.bulletSpeed,
				dir[1] * constants.bulletSpeed
			]),
			wire(io).o(
				wire(io).o(
					wire(io).hold,
					wire(io).now
				),
				shipVelocityWire
			)
		)
	);
};

var spawnAsteroidIO = function() {
	var asteroid = document.createElementNS("http://www.w3.org/2000/svg", "polygon");

};

var bulletCommandWire = function(bullet, initPos, dir) {
	return wire(io).next(
		wire(io).o(
			wire(io).for_(constants.bulletLifespan),
			wire(io).map(
				function(bulletPosition) {
					return {
						type:'sideEffect',
						value: function() {
							bullet.setAttribute("cx", bulletPosition[0]);
							bullet.setAttribute("cy", bulletPosition[1]);
						}
					};
				},
				bulletPositionWire(initPos, dir)
			)
		),
		function(dt, x) {
			return io.pure([
				wvChanged({
					type:'sideEffect',
					value: function() {
						svg.removeChild(bullet);
					}
				}),
				wire(io).inhibit
			]);
		}
	);
};

var shipAngleCommandWire = wire(io).map(
	function(shipAngle) {
		return {type:'setShipAngle', value: shipAngle};
	},
	shipAngleWire
);

var shipPositionCommandWire = wire(io).map(
	function(shipPosition) {
		return {type:'setShipPosition', value: shipPosition};
	},
	shipPositionWire
);

var shipFireCommandWire = wire(io).map(
	function(fire) {
		if (fire) {
			return {type:'fire'};
		} else {
			return {type:'none'};
		}
	},
	shipFireWire
);

commandWires = [
	shipAngleCommandWire,
	shipPositionCommandWire,
	shipFireCommandWire
];

var audioCtx = new (window.AudioContext || window.webkitAudioContext)();
var explosionBuffer;
var ufoBuffer;
var deathBuffer;
var pewBuffer;
var svg;
var svgShipAngle;
var svgShipPosition;
var shipPosition;
var shipDirection;

var lastMs = new Date().getTime();
var fireInput = function(input) {
	var ms = new Date().getTime();
	var dt = (ms - lastMs) / 1000.0;
	lastMs = ms;
	for (i = commandWires.length-1; i >= 0; --i) {
		var x = commandWires[i](dt, wvChanged(input))();
		commandWires[i] = x[1];
		x[0]({
			wvInhibited: function() {
				return function() {
					commandWires.splice(i, 1);
				};
			},
			wvUnchanged: function(a) {
				return function() {};
			},
			wvChanged: function(a) {
				return function() {
					if (a.type == 'setShipAngle') {
						shipDirection = [
							-Math.sin(a.value * Math.PI / 180.0),
							Math.cos(a.value * Math.PI / 180.0)
						];
						svgShipAngle.transform.baseVal.getItem(0).setRotate(a.value, 0, -8);
					} else if (a.type == 'setShipPosition') {
						shipPosition = a.value;
						svgShipPosition.transform.baseVal.getItem(0).setTranslate(a.value[0], a.value[1]);
					} else if (a.type == 'fire') {
						spawnBulletIO(shipPosition, shipDirection)();
						play(audioCtx, pewBuffer)();
						fireInput(a);
					} else if (a.type == "sideEffect") {
						a.value();
					}
				};
			}
		})();
	}
};

var init = function() {
	svg = document.getElementById("svg");
	svgShipAngle = document.getElementById("svgShipAngle");
	svgShipPosition = document.getElementById("svgShipPosition");

	explosionBuffer = render(audioCtx, explosion(wire(io), io))();
	ufoBuffer = render(audioCtx, ufo(wire(io), io))();
	deathBuffer = render(audioCtx, death(wire(io), io))();
	pewBuffer = render(audioCtx, pew(wire(io), io))();

	var lastMs = new Date().getTime();
	setInterval(
		function() {
			var ms = new Date().getTime();
			var dt = (ms - lastMs) / 1000.0;
			fireInput({type:'dt', dt: dt});
			lastMs = ms;
		},
		16
	);
};

document.onkeydown = function(e) {
	fireInput({type:"keyDown", keyCode: e.keyCode});
	if (e.keyCode == 49) {
		play(audioCtx, explosionBuffer)();
	} else if (e.keyCode == 50) {
		play(audioCtx, ufoBuffer)();
	} else if (e.keyCode == 51) {
		play(audioCtx, deathBuffer)();
	} else if (e.keyCode == 52) {
		play(audioCtx, pewBuffer)();
	}
};

document.onkeyup = function(e) {
	fireInput({type:"keyUp", keyCode: e.keyCode});
};
		</script>
	</head>
	<body style="margin:0px" onload="init()" bgcolor="#000000" fgcolor="#FFFFFF">
		<svg id="svg" width="100%" height="100%" fill="white">
			<g id="svgShipPosition" transform="translate(100,100)">
				<g id="svgShipAngle" transform="rotate(0)">
					<path d="M 0 0 L -5 -12 L 5 -12 Z" />
				</g>
			</g>
			<text id="svgTestNoise" x="15" y="15" fill="red"></text>
		</svg>
	</body>
</html>
